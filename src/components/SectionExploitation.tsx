import React, { useMemo, useRef } from 'react';
// We don't need useTranslation hook here because we accept 't' as a prop
import type { AppData, ExploitationData, LabAnalysisRow } from '../types/budget';
import { Factory, Activity, Scale, Settings, Microscope, Upload } from 'lucide-react';
import * as XLSX from 'xlsx';

interface Props {
  data: AppData;
  onChange: (data: AppData) => void;
  // We define 't' here so the parent (Budget.tsx) can pass it down
  t: (key: string) => string; 
}

// Configuration for the Laboratory Analysis Table Structure
const LAB_SECTIONS = [
  {
    title: 'I. FOOD PRODUCTS',
    key: 'food',
    rows: [
      { id: 'lab_fresh_food', label: 'Fresh Food' },
      { id: 'lab_drinks', label: 'Drinks' },
      { id: 'lab_edible_oils', label: 'Edible Oils' },
      { id: 'lab_misc_food', label: 'Misc. Food' },
      { id: 'lab_agri_products', label: 'Agri. Products' },
    ]
  },
  {
    title: 'II. NON-FOOD PRODUCTS',
    key: 'non_food',
    rows: [
      { id: 'lab_chemical', label: 'Chemical Products' },
      { id: 'lab_chem_eng', label: 'Chemistry Engineering Products' },
      { id: 'lab_textile', label: 'Textile Products' },
      { id: 'lab_drugs', label: 'Drugs' },
      { id: 'lab_cosmetic', label: 'Cosmetic Products' },
      { id: 'lab_med_plants', label: 'Medicinal Plants' },
    ]
  },
  {
    title: 'III. PETROLEUM PRODUCTS',
    key: 'petroleum',
    rows: [
      { id: 'lab_petroleum', label: 'Petroleum Products' },
    ]
  },
  {
    title: 'IV. MINING PRODUCTS',
    key: 'mining',
    rows: [
      { id: 'lab_mining', label: 'Mining Products' },
    ]
  }
];

const SectionExploitation: React.FC<Props> = ({ data, onChange, t }) => {
  const fileInputRef = useRef<HTMLInputElement>(null);
  
  const exploitation = data?.exploitation || {
    operatingData: [],
    failures: [],
    labAnalysis: [],
    metrology: [],
    technicalControl: []
  };

  const handleExcelUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const fileData = e.target?.result;
        const workbook = XLSX.read(fileData, { type: 'binary' });

        const newExploitation: ExploitationData = {
          operatingData: [],
          failures: [],
          labAnalysis: [],
          metrology: [],
          technicalControl: [],
        };

        // Parse Operating Data sheet
        if (workbook.SheetNames.includes('Operating Data')) {
          const sheet = workbook.Sheets['Operating Data'];
          const jsonData = XLSX.utils.sheet_to_json<Record<string, unknown>>(sheet);
          newExploitation.operatingData = jsonData.map((row, index) => ({
            id: String(row.id || `op${index + 1}`),
            category: String(row.Category || row.category || ''),
            subcategory: String(row.Subcategory || row.subcategory || ''),
            volume: {
              kgs: parseFloat(String(row['Volume KGS'] ?? row.kgs ?? '0')) || 0,
              m3: parseFloat(String(row['Volume M3'] ?? row.m3 ?? '0')) || 0,
              litre: parseFloat(String(row['Volume Litre'] ?? row.litre ?? '0')) || 0,
            },
            value: {
              cif: parseFloat(String(row['Value CIF'] ?? row.cif ?? '0')) || 0,
              fob: parseFloat(String(row['Value FOB'] ?? row.fob ?? '0')) || 0,
              marchande: parseFloat(String(row['Value Marchande'] ?? row.marchande ?? '0')) || 0,
            },
            occFees: parseFloat(String(row['OCC Fees'] ?? row.occFees ?? '0')) || 0,
            dpdVerification: parseFloat(String(row['DPD Verification'] ?? row.dpdVerification ?? '0')) || 0,
            result: parseFloat(String(row.Result ?? row.result ?? '0')) || 0,
          }));
        }

        // Parse Failures sheet
        if (workbook.SheetNames.includes('Failures')) {
          const sheet = workbook.Sheets['Failures'];
          const jsonData = XLSX.utils.sheet_to_json<Record<string, unknown>>(sheet);
          newExploitation.failures = jsonData.map((row, index) => ({
            id: String(row.id || `f${index + 1}`),
            name: String(row.Name || row.name || ''),
            count: String(row.Count ?? row.count ?? '') !== '' ? parseFloat(String(row.Count ?? row.count ?? '0')) : 0,
          }));
        }

        // Parse Lab Analysis sheet
        if (workbook.SheetNames.includes('Lab Analysis')) {
          const sheet = workbook.Sheets['Lab Analysis'];
          const jsonData = XLSX.utils.sheet_to_json<Record<string, unknown>>(sheet);
          newExploitation.labAnalysis = jsonData.map((row) => ({
            id: String(row.id || ''),
            category: String(row.Category || row.category || ''),
            product: String(row.Product || row.product || ''),
            received: parseFloat(String(row.Received ?? row.received ?? '0')) || 0,
            analyzed: parseFloat(String(row.Analyzed ?? row.analyzed ?? '0')) || 0,
            nonCompliant: parseFloat(String(row['Non Compliant'] ?? row.nonCompliant ?? '0')) || 0,
            compliant: parseFloat(String(row.Compliant ?? row.compliant ?? '0')) || 0,
          }));
        }

        // Parse Metrology sheet
        if (workbook.SheetNames.includes('Metrology')) {
          const sheet = workbook.Sheets['Metrology'];
          const jsonData = XLSX.utils.sheet_to_json<Record<string, unknown>>(sheet);
          newExploitation.metrology = jsonData.map((row, index) => ({
            id: String(row.id || `met${index + 1}`),
            name: String(row.Name || row.name || ''),
            count: parseFloat(String(row.Count ?? row.count ?? '0')) || 0,
          }));
        }

        // Parse Technical Control sheet
        if (workbook.SheetNames.includes('Technical Control')) {
          const sheet = workbook.Sheets['Technical Control'];
          const jsonData = XLSX.utils.sheet_to_json<Record<string, unknown>>(sheet);
          newExploitation.technicalControl = jsonData.map((row, index) => ({
            id: String(row.id || `tc${index + 1}`),
            name: String(row.Name || row.name || ''),
            count: parseFloat(String(row.Count ?? row.count ?? '0')) || 0,
          }));
        }

        onChange({
          ...data,
          exploitation: newExploitation,
        });

        alert(t('Exploitation data uploaded successfully!'));
      } catch (error) {
        console.error('Error parsing Excel file:', error);
        alert(t('Error parsing Excel file. Please ensure sheets are named correctly: Operating Data, Failures, Lab Analysis, Metrology, Technical Control'));
      }
    };
    reader.readAsBinaryString(file);
    
    // Reset input
    if (event.target) event.target.value = '';
  };

  const updateExploitation = (newData: Partial<ExploitationData>) => {
    onChange({
      ...data,
      exploitation: { ...exploitation, ...newData }
    });
  };

  // --- Handlers ---

  const handleOperatingChange = (id: string, group: 'volume' | 'value' | 'root', field: string, val: string) => {
    const num = parseFloat(val) || 0;
    const newOpData = (exploitation.operatingData || []).map(row => {
      if (row.id !== id) return row;
      if (group === 'root') {
        return { ...row, [field]: num };
      } else {
        const groupKey = group as 'volume' | 'value';
        const currentGroupData = row[groupKey] || { kgs: 0, m3: 0, litre: 0, cif: 0, fob: 0, marchande: 0 };
        return { ...row, [groupKey]: { ...currentGroupData, [field]: num } };
      }
    });
    updateExploitation({ operatingData: newOpData });
  };

  const handleServiceChange = (listName: 'failures' | 'metrology' | 'technicalControl', id: string, val: string) => {
    // For failures, allow text or number. For others, force number.
    const newVal = listName === 'failures' ? val : (parseFloat(val) || 0);
    
    const list = exploitation[listName] || [];
    const newList = list.map(row => 
      row.id === id ? { ...row, count: newVal } : row
    );
    updateExploitation({ [listName]: newList });
  };

  const handleLabChange = (id: string, field: string, val: string) => {
    const num = parseFloat(val) || 0;
    const currentLabData = exploitation.labAnalysis || [];
    
    const exists = currentLabData.find((r: LabAnalysisRow) => r.id === id);
    let newLabData;

    if (exists) {
        newLabData = currentLabData.map((r: LabAnalysisRow) => r.id === id ? { ...r, [field]: num } : r);
    } else {
        newLabData = [...currentLabData, { id, category: '', product: '', received: 0, analyzed: 0, nonCompliant: 0, compliant: 0, [field]: num }];
    }

    updateExploitation({ labAnalysis: newLabData });
  };

  const getLabValue = (id: string, field: string) => {
    const row = (exploitation.labAnalysis || []).find((r: LabAnalysisRow) => r.id === id);
    return row ? (row as unknown as Record<string, number | string>)[field] : 0;
  };

  // --- Calculations ---

  const opTotals = useMemo(() => (exploitation.operatingData || []).reduce((acc, row) => ({
    kgs: acc.kgs + (row.volume?.kgs || 0),
    m3: acc.m3 + (row.volume?.m3 || 0),
    litre: acc.litre + (row.volume?.litre || 0),
    cif: acc.cif + (row.value?.cif || 0),
    fob: acc.fob + (row.value?.fob || 0),
    marchande: acc.marchande + (row.value?.marchande || 0),
    occFees: acc.occFees + (row.occFees || 0),
    dpdVerification: acc.dpdVerification + (row.dpdVerification || 0),
    result: acc.result + (row.result || 0),
  }), { kgs: 0, m3: 0, litre: 0, cif: 0, fob: 0, marchande: 0, occFees: 0, dpdVerification: 0, result: 0 }), [exploitation.operatingData]);

  const labTotals = useMemo(() => {
    const data = exploitation.labAnalysis || [];
    const totals = { received: 0, analyzed: 0, nonCompliant: 0, compliant: 0 };
    data.forEach((row: LabAnalysisRow) => {
        totals.received += row.received || 0;
        totals.analyzed += row.analyzed || 0;
        totals.nonCompliant += row.nonCompliant || 0;
        totals.compliant += row.compliant || 0;
    });
    return totals;
  }, [exploitation.labAnalysis]);

  const getSectionSubtotal = (rowIds: string[]) => {
    const sub = { received: 0, analyzed: 0, nonCompliant: 0, compliant: 0 };
    rowIds.forEach(id => {
        const row = (exploitation.labAnalysis || []).find((r: LabAnalysisRow) => r.id === id);
        if (row) {
            sub.received += row.received || 0;
            sub.analyzed += row.analyzed || 0;
            sub.nonCompliant += row.nonCompliant || 0;
            sub.compliant += row.compliant || 0;
        }
    });
    return sub;
  };

  const totalMetrology = (exploitation.metrology || []).reduce((acc, curr) => acc + (typeof curr.count === 'number' ? curr.count : 0), 0);
  const totalTechControl = (exploitation.technicalControl || []).reduce((acc, curr) => acc + (typeof curr.count === 'number' ? curr.count : 0), 0);

  if (!data?.exploitation) {
    return (
      <div className="p-12 text-center text-slate-500 bg-white rounded-lg shadow-sm border border-slate-200">
        <Factory className="w-12 h-12 text-slate-300 mx-auto mb-3" />
        <p>Exploitation data is not available.</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      
      {/* Upload Button */}
      <div className="flex justify-end">
        <input
          ref={fileInputRef}
          type='file'
          accept='.xlsx,.xls'
          onChange={handleExcelUpload}
          className='hidden'
        />
        <button
          onClick={() => fileInputRef.current?.click()}
          className='flex items-center gap-2 px-4 py-2 bg-gray-900 hover:bg-black text-white rounded-lg transition-all text-sm font-medium shadow-md hover:shadow-lg'
        >
          <Upload className='w-4 h-4' />
          {t('Upload Exploitation Excel')}
        </button>
      </div>

      {/* --- 1. OPERATING DATA --- */}
      <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 overflow-hidden">
        <div className="px-6 py-3 bg-linear-to-r from-indigo-50 to-slate-50 border-b-2 border-slate-200">
          <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
            <Factory className="w-5 h-5 text-gray-700" />
            {t('sec_operating')}
          </h2>
        </div>
        <div className="p-6">
            <div className="overflow-x-auto">
                <table className="w-full text-xs text-left text-slate-600 min-w-250 border-collapse">
                    <thead className="text-xs text-slate-700 uppercase bg-linear-to-r from-slate-100 to-slate-50">
                        <tr className="border-b-2 border-slate-300">
                            <th className="px-2 py-3 sticky left-0 bg-slate-100 z-10 w-48 border-r border-slate-200 shadow-[1px_0_0_0_rgba(0,0,0,0.05)] border-t border-l">
                                {t('Entity')}
                            </th>
                            <th colSpan={3} className="px-2 py-1 text-center border-l border-r border-t border-slate-300 bg-gray-50 text-gray-800">
                                {t('Volume')}
                            </th>
                            <th colSpan={3} className="px-2 py-1 text-center border-r border-t border-slate-300 bg-gray-50 text-gray-800">
                                {t('Value')}
                            </th>
                            <th colSpan={3} className="px-2 py-1 text-center border-l border-t border-r bg-gray-50 text-gray-800 font-bold">
                                {t('DPD VERIFICATION')}
                            </th>
                        </tr>
                        <tr className="bg-slate-50 border-b border-slate-200">
                            <th className="sticky left-0 bg-slate-50 z-10 border-r border-l border-slate-200"></th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500 border-l">{t("KGS")}</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500">{t("mÂ³")}</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500 border-r">{t("Litre")}</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500">{t("CIF")}</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500">{t("FOB")}</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500 border-r">{t("Merchant")}</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500 border-l">{t("TARIF OCC")}</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500">{t("VERIF.")}</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500 border-r">{t("RESULT")}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {(exploitation.operatingData || []).map((row) => (
                            <tr key={row.id} className="border-b hover:bg-slate-50">
                                <td className="px-2 py-2 font-medium sticky left-0 bg-white hover:bg-slate-50 z-10 border-r border-l border-slate-200 shadow-[1px_0_0_0_rgba(0,0,0,0.05)]">
                                    {t(row.category)}
                                </td>
                                <td className="p-1 border-l">
                                    <input type="number" className="w-full text-center p-1.5 border-2 border-gray-300 rounded-lg text-xs bg-white text-black focus:ring-2 focus:ring-gray-500 focus:border-gray-400 outline-none hover:border-gray-400 transition-all" value={row.volume?.kgs || 0} onChange={(e) => handleOperatingChange(row.id, 'volume', 'kgs', e.target.value)} />
                                </td>
                                <td className="p-1">
                                    <input type="number" className="w-full text-center p-1.5 border-2 border-gray-300 rounded-lg text-xs bg-white text-black focus:ring-2 focus:ring-gray-500 focus:border-gray-400 outline-none hover:border-gray-400 transition-all" value={row.volume?.m3 || 0} onChange={(e) => handleOperatingChange(row.id, 'volume', 'm3', e.target.value)} />
                                </td>
                                <td className="p-1 border-r">
                                    <input type="number" className="w-full text-center p-1.5 border-2 border-gray-300 rounded-lg text-xs bg-white text-black focus:ring-2 focus:ring-gray-500 focus:border-gray-400 outline-none hover:border-gray-400 transition-all" value={row.volume?.litre || 0} onChange={(e) => handleOperatingChange(row.id, 'volume', 'litre', e.target.value)} />
                                </td>
                                <td className="p-1">
                                    <input type="number" className="w-full text-center p-1.5 border-2 border-gray-300 rounded-lg text-xs bg-white text-black focus:ring-2 focus:ring-gray-500 focus:border-gray-400 outline-none hover:border-gray-400 transition-all" value={row.value?.cif || 0} onChange={(e) => handleOperatingChange(row.id, 'value', 'cif', e.target.value)} />
                                </td>
                                <td className="p-1">
                                    <input type="number" className="w-full text-center p-1.5 border-2 border-gray-300 rounded-lg text-xs bg-white text-black focus:ring-2 focus:ring-gray-500 focus:border-gray-400 outline-none hover:border-gray-400 transition-all" value={row.value?.fob || 0} onChange={(e) => handleOperatingChange(row.id, 'value', 'fob', e.target.value)} />
                                </td>
                                <td className="p-1 border-r">
                                    <input type="number" className="w-full text-center p-1.5 border-2 border-gray-300 rounded-lg text-xs bg-white text-black focus:ring-2 focus:ring-gray-500 focus:border-gray-400 outline-none hover:border-gray-400 transition-all" value={row.value?.marchande || 0} onChange={(e) => handleOperatingChange(row.id, 'value', 'marchande', e.target.value)} />
                                </td>
                                <td className="p-1 border-l">
                                    <input type="number" className="w-full text-center p-1.5 border-2 border-gray-300 rounded-lg text-xs font-semibold bg-white text-black focus:ring-2 focus:ring-gray-500 focus:border-gray-400 outline-none hover:border-gray-400 transition-all" value={row.occFees || 0} onChange={(e) => handleOperatingChange(row.id, 'root', 'occFees', e.target.value)} />
                                </td>
                                <td className="p-1">
                                    <input type="number" className="w-full text-center p-1.5 border-2 border-gray-300 rounded-lg text-xs bg-white text-black focus:ring-2 focus:ring-gray-500 focus:border-gray-400 outline-none hover:border-gray-400 transition-all" value={row.dpdVerification || 0} onChange={(e) => handleOperatingChange(row.id, 'root', 'dpdVerification', e.target.value)} />
                                </td>
                                <td className="p-1 border-r">
                                    <input type="number" className="w-full text-center p-1.5 border-2 border-gray-300 rounded-lg text-xs font-bold bg-white text-black focus:ring-2 focus:ring-gray-500 focus:border-gray-400 outline-none hover:border-gray-400 transition-all" value={row.result || 0} onChange={(e) => handleOperatingChange(row.id, 'root', 'result', e.target.value)} />
                                </td>
                            </tr>
                        ))}
                        <tr className="bg-linear-to-r from-slate-800 to-slate-700 text-white font-bold border-t-4 border-slate-900">
                            <td className="px-2 py-2 text-right sticky left-0 bg-slate-800 z-10 border-r border-l border-slate-600 shadow-[1px_0_0_0_rgba(0,0,0,0.05)]">
                                TOTAL
                            </td>
                            <td className="px-1 py-2 text-center text-xs border-l border-slate-600">{opTotals.kgs.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs">{opTotals.m3.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs border-r border-slate-600">{opTotals.litre.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs">{opTotals.cif.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs">{opTotals.fob.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs border-r border-slate-600">{opTotals.marchande.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs border-l border-slate-600">{opTotals.occFees.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs">{opTotals.dpdVerification.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs border-r border-slate-600 text-white">{opTotals.result.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
      </div>

      {/* --- 2. FAILURES --- */}
      <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 overflow-hidden">
        <div className="px-6 py-3 bg-linear-to-r from-gray-50 to-slate-50 border-b-2 border-slate-200">
          <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
            <Activity className="w-5 h-5 text-gray-600" />
            {t('Failures')}
          </h3>
        </div>
        <div className="p-6">
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left border-collapse">
              <thead className="bg-linear-to-r from-slate-100 to-slate-50 text-slate-700">
                <tr className="border-b-2 border-slate-300">
                  <th className="p-3 border-b border-r border-slate-200 w-2/3 font-semibold">{t('Benefit')}</th>
                  <th className="p-3 border-b border-slate-200 w-1/3 text-center font-semibold">{t('Name')}</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                {(exploitation.failures || []).map(f => (
                  <tr key={f.id} className="border-b border-slate-200 hover:bg-gray-50 transition-all duration-150">
                    <td className="p-3 border-r border-slate-200 font-medium text-slate-700">{t(f.name)}</td>
                    <td className="p-2">
                      <input 
                        type="text" 
                        className="w-full text-center p-1.5 border-2 border-gray-300 rounded-lg bg-white text-black outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400 hover:border-gray-400 transition-all font-semibold" 
                        value={f.count} 
                        onChange={e => handleServiceChange('failures', f.id, e.target.value)} 
                      />
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* --- 3. LABORATORY ANALYSIS --- */}
      <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 overflow-hidden">
        <div className="px-6 py-3 bg-linear-to-r from-gray-50 to-slate-50 border-b-2 border-slate-200">
          <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
            <Microscope className="w-5 h-5 text-gray-700" />
            {t('Laboratory Analysis')}
          </h2>
        </div>
        <div className="p-6">
          <div className="overflow-x-auto">
            <table className="w-full text-xs text-left border-collapse">
              <thead className="bg-linear-to-r from-slate-100 to-slate-50 text-slate-600">
                <tr className="border-b-2 border-slate-300">
                  <th className="p-3 border-b border-r border-slate-200 w-1/3 font-semibold">{t('NATURE SAMPLES')}</th>
                  <th className="p-3 border-b border-r border-slate-200 text-center font-semibold">{t('RECEIVED')}</th>
                  <th className="p-3 border-b border-r border-slate-200 text-center font-semibold">{t('ANALYZED')}</th>
                  <th className="p-3 border-b border-r border-slate-200 text-center bg-gray-50 text-gray-800 font-semibold">{t('NON COMP.')}</th>
                  <th className="p-3 border-b border-slate-200 text-center bg-gray-50 text-gray-800 font-semibold">{t('CONFORMITY')}</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">{LAB_SECTIONS.map((section) => {
                  const sectionSubtotal = getSectionSubtotal(section.rows.map(r => r.id));
                  return (
                    <React.Fragment key={section.key}>
                      <tr className="bg-linear-to-r from-slate-100 to-slate-50 border-b-2 border-slate-200">
                        <td colSpan={5} className="p-2 font-bold text-slate-800 uppercase tracking-wide">
                          {t(section.title)}
                        </td>
                      </tr>
                                    {section.rows.map((row) => (
                      <tr key={row.id} className="border-b border-slate-200 hover:bg-gray-50 transition-all duration-150">
                        <td className="p-2 border-r border-slate-200 pl-6">
                          <div className="text-slate-700 font-medium">{t(row.label)}</div>
                        </td>
                        <td className="p-1 border-r border-slate-200">
                          <input type="number" min="0" className="w-full p-1.5 border-2 border-gray-300 rounded-lg text-center bg-white text-black outline-none focus:ring-2 focus:ring-gray-500 focus:border-gray-400 hover:border-gray-400 transition-all font-semibold" value={getLabValue(row.id, 'received')} onChange={(e) => handleLabChange(row.id, 'received', e.target.value)} />
                        </td>
                        <td className="p-1 border-r border-slate-200">
                          <input type="number" min="0" className="w-full p-1.5 border-2 border-gray-300 rounded-lg text-center bg-white text-black outline-none focus:ring-2 focus:ring-gray-500 focus:border-gray-400 hover:border-gray-400 transition-all font-semibold" value={getLabValue(row.id, 'analyzed')} onChange={(e) => handleLabChange(row.id, 'analyzed', e.target.value)} />
                        </td>
                        <td className="p-1 border-r border-slate-200 bg-gray-50/40">
                          <input type="number" min="0" className="w-full p-1.5 border-2 border-gray-300 rounded-lg text-center bg-white text-black outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400 hover:border-gray-400 transition-all font-semibold" value={getLabValue(row.id, 'nonCompliant')} onChange={(e) => handleLabChange(row.id, 'nonCompliant', e.target.value)} />
                        </td>
                        <td className="p-1 bg-gray-50/40">
                          <input type="number" min="0" className="w-full p-1.5 border-2 border-gray-300 rounded-lg text-center bg-white text-black outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400 hover:border-gray-400 transition-all font-semibold" value={getLabValue(row.id, 'compliant')} onChange={(e) => handleLabChange(row.id, 'compliant', e.target.value)} />
                                            </td>
                                        </tr>
                                    ))}
                      <tr className="bg-linear-to-r from-slate-200 to-slate-100 font-bold border-b-2 border-slate-300 text-slate-800">
                        <td className="p-2 text-right pr-4 italic text-xs uppercase">{t('SOUS TOTAL')}</td>
                        <td className="p-2 text-center text-xs font-mono">{sectionSubtotal.received}</td>
                        <td className="p-2 text-center text-xs font-mono">{sectionSubtotal.analyzed}</td>
                        <td className="p-2 text-center text-xs font-mono">{sectionSubtotal.nonCompliant}</td>
                        <td className="p-2 text-center text-xs font-mono">{sectionSubtotal.compliant}</td>
                      </tr>
                    </React.Fragment>
                  );
                })}
                <tr className="bg-linear-to-r from-slate-800 to-slate-700 text-white font-bold border-t-4 border-slate-900">
                  <td className="p-3 border-r border-slate-600 text-right uppercase tracking-wider">{t('TOTAL GLOBAL')}</td>
                  <td className="p-3 border-r border-slate-600 text-center font-mono">{labTotals.received}</td>
                  <td className="p-3 border-r border-slate-600 text-center font-mono">{labTotals.analyzed}</td>
                  <td className="p-3 border-r border-slate-600 text-center text-white font-mono">{labTotals.nonCompliant}</td>
                  <td className="p-3 text-center text-gray-100 font-mono">{labTotals.compliant}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* --- 4. METROLOGY --- */}
      <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 overflow-hidden">
        <div className="px-6 py-3 bg-linear-to-r from-gray-50 to-slate-50 border-b-2 border-slate-200">
          <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
            <Scale className="w-5 h-5 text-gray-600" />
            {t('Metrology')}
          </h3>
        </div>
        <div className="p-6">
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left border-collapse">
              <thead className="bg-linear-to-r from-slate-100 to-slate-50 text-slate-700">
                <tr className="border-b-2 border-slate-300">
                  <th className="p-3 border-b border-r border-slate-200 w-2/3 font-semibold">{t('PRESTATION')}</th>
                  <th className="p-3 border-b border-slate-200 w-1/3 text-center font-semibold">{t('NUMBER OF DEVICES')}</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {(exploitation.metrology || []).map(m => (
                  <tr key={m.id} className="border-b border-slate-200 hover:bg-gray-50 transition-all duration-150">
                    <td className="p-3 border-r border-slate-200 font-medium text-slate-700">{t(m.name)}</td>
                    <td className="p-2">
                      <input 
                        type="number" 
                        className="w-full text-center p-1.5 border-2 border-gray-300 rounded-lg bg-white text-black outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400 hover:border-gray-400 transition-all font-semibold" 
                        value={m.count || 0} 
                        onChange={e => handleServiceChange('metrology', m.id, e.target.value)} 
                      />
                    </td>
                  </tr>
                ))}
                <tr className="bg-linear-to-r from-slate-800 to-slate-700 text-white font-bold border-t-4 border-slate-900">
                  <td className="p-3 border-r border-slate-600 text-right uppercase tracking-wider">{t('SUB TOTAL')}</td>
                  <td className="p-3 text-center text-white font-mono">{totalMetrology}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* --- 5. TECHNICAL CONTROL --- */}
      <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 overflow-hidden">
        <div className="px-6 py-3 bg-linear-to-r from-slate-50 to-slate-50 border-b-2 border-slate-200">
          <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
            <Settings className="w-5 h-5 text-slate-500" />
            {t('TechControl')}
          </h3>
        </div>
        <div className="p-6">
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left border-collapse">
              <thead className="bg-linear-to-r from-slate-100 to-slate-50 text-slate-700">
                <tr className="border-b-2 border-slate-300">
                  <th className="p-3 border-b border-r border-slate-200 w-2/3 font-semibold">{t('Designation')}</th>
                  <th className="p-3 border-b border-slate-200 w-1/3 text-center font-semibold">{t('Count')}</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {(exploitation.technicalControl || []).map(tc => (
                  <tr key={tc.id} className="border-b border-slate-200 hover:bg-slate-50 transition-all duration-150">
                    <td className="p-3 border-r border-slate-200 font-medium text-slate-700">{t(tc.name)}</td>
                    <td className="p-2">
                      <input 
                        type="number" 
                        className="w-full text-center p-1.5 border-2 border-slate-300 rounded-lg bg-white text-black outline-none focus:ring-2 focus:ring-slate-400 focus:border-slate-400 hover:border-slate-400 transition-all font-semibold" 
                        value={tc.count || 0} 
                        onChange={e => handleServiceChange('technicalControl', tc.id, e.target.value)} 
                      />
                    </td>
                  </tr>
                ))}
                <tr className="bg-linear-to-r from-slate-800 to-slate-700 text-white font-bold border-t-4 border-slate-900">
                  <td className="p-3 border-r border-slate-600 text-right uppercase tracking-wider">{t('TOTAL')}</td>
                  <td className="p-3 text-center text-white font-mono">{totalTechControl}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
};

export default SectionExploitation;