import React, { useMemo } from 'react';
// We don't need useTranslation hook here because we accept 't' as a prop
import type { AppData, ExploitationData, LabAnalysisRow } from '../types/budget';
import { Factory, Activity, Scale, Settings, Microscope } from 'lucide-react';

interface Props {
  data: AppData;
  onChange: (data: AppData) => void;
  // We define 't' here so the parent (Budget.tsx) can pass it down
  t: (key: string) => string; 
}

// Configuration for the Laboratory Analysis Table Structure
const LAB_SECTIONS = [
  {
    title: 'I. FOOD PRODUCTS',
    key: 'food',
    rows: [
      { id: 'lab_fresh_food', label: 'Fresh Food' },
      { id: 'lab_drinks', label: 'Drinks' },
      { id: 'lab_edible_oils', label: 'Edible Oils' },
      { id: 'lab_misc_food', label: 'Misc. Food' },
      { id: 'lab_agri_products', label: 'Agri. Products' },
    ]
  },
  {
    title: 'II. NON-FOOD PRODUCTS',
    key: 'non_food',
    rows: [
      { id: 'lab_chemical', label: 'Chemical Products' },
      { id: 'lab_chem_eng', label: 'Chemistry Engineering Products' },
      { id: 'lab_textile', label: 'Textile Products' },
      { id: 'lab_drugs', label: 'Drugs' },
      { id: 'lab_cosmetic', label: 'Cosmetic Products' },
      { id: 'lab_med_plants', label: 'Medicinal Plants' },
    ]
  },
  {
    title: 'III. PETROLEUM PRODUCTS',
    key: 'petroleum',
    rows: [
      { id: 'lab_petroleum', label: 'Petroleum Products' },
    ]
  },
  {
    title: 'IV. MINING PRODUCTS',
    key: 'mining',
    rows: [
      { id: 'lab_mining', label: 'Mining Products' },
    ]
  }
];

const SectionExploitation: React.FC<Props> = ({ data, onChange, t }) => {
  const exploitation = data?.exploitation || {
    operatingData: [],
    failures: [],
    labAnalysis: [],
    metrology: [],
    technicalControl: []
  };

  const updateExploitation = (newData: Partial<ExploitationData>) => {
    onChange({
      ...data,
      exploitation: { ...exploitation, ...newData }
    });
  };

  // --- Handlers ---

  const handleOperatingChange = (id: string, group: 'volume' | 'value' | 'root', field: string, val: string) => {
    const num = parseFloat(val) || 0;
    const newOpData = (exploitation.operatingData || []).map(row => {
      if (row.id !== id) return row;
      if (group === 'root') {
        return { ...row, [field]: num };
      } else {
        const groupKey = group as 'volume' | 'value';
        const currentGroupData = row[groupKey] || { kgs: 0, m3: 0, litre: 0, cif: 0, fob: 0, marchande: 0 };
        return { ...row, [groupKey]: { ...currentGroupData, [field]: num } };
      }
    });
    updateExploitation({ operatingData: newOpData });
  };

  const handleServiceChange = (listName: 'failures' | 'metrology' | 'technicalControl', id: string, val: string) => {
    // For failures, allow text or number. For others, force number.
    const newVal = listName === 'failures' ? val : (parseFloat(val) || 0);
    
    const list = exploitation[listName] || [];
    const newList = list.map(row => 
      row.id === id ? { ...row, count: newVal } : row
    );
    updateExploitation({ [listName]: newList });
  };

  const handleLabChange = (id: string, field: string, val: string) => {
    const num = parseFloat(val) || 0;
    const currentLabData = exploitation.labAnalysis || [];
    
    const exists = currentLabData.find((r: LabAnalysisRow) => r.id === id);
    let newLabData;

    if (exists) {
        newLabData = currentLabData.map((r: LabAnalysisRow) => r.id === id ? { ...r, [field]: num } : r);
    } else {
        newLabData = [...currentLabData, { id, category: '', product: '', received: 0, analyzed: 0, nonCompliant: 0, compliant: 0, [field]: num }];
    }

    updateExploitation({ labAnalysis: newLabData });
  };

  const getLabValue = (id: string, field: string) => {
    const row = (exploitation.labAnalysis || []).find((r: LabAnalysisRow) => r.id === id);
    return row ? (row as unknown as Record<string, number | string>)[field] : 0;
  };

  // --- Calculations ---

  const opTotals = useMemo(() => (exploitation.operatingData || []).reduce((acc, row) => ({
    kgs: acc.kgs + (row.volume?.kgs || 0),
    m3: acc.m3 + (row.volume?.m3 || 0),
    litre: acc.litre + (row.volume?.litre || 0),
    cif: acc.cif + (row.value?.cif || 0),
    fob: acc.fob + (row.value?.fob || 0),
    marchande: acc.marchande + (row.value?.marchande || 0),
    occFees: acc.occFees + (row.occFees || 0),
    dpdVerification: acc.dpdVerification + (row.dpdVerification || 0),
    result: acc.result + (row.result || 0),
  }), { kgs: 0, m3: 0, litre: 0, cif: 0, fob: 0, marchande: 0, occFees: 0, dpdVerification: 0, result: 0 }), [exploitation.operatingData]);

  const labTotals = useMemo(() => {
    const data = exploitation.labAnalysis || [];
    const totals = { received: 0, analyzed: 0, nonCompliant: 0, compliant: 0 };
    data.forEach((row: LabAnalysisRow) => {
        totals.received += row.received || 0;
        totals.analyzed += row.analyzed || 0;
        totals.nonCompliant += row.nonCompliant || 0;
        totals.compliant += row.compliant || 0;
    });
    return totals;
  }, [exploitation.labAnalysis]);

  const getSectionSubtotal = (rowIds: string[]) => {
    const sub = { received: 0, analyzed: 0, nonCompliant: 0, compliant: 0 };
    rowIds.forEach(id => {
        const row = (exploitation.labAnalysis || []).find((r: LabAnalysisRow) => r.id === id);
        if (row) {
            sub.received += row.received || 0;
            sub.analyzed += row.analyzed || 0;
            sub.nonCompliant += row.nonCompliant || 0;
            sub.compliant += row.compliant || 0;
        }
    });
    return sub;
  };

  const totalMetrology = (exploitation.metrology || []).reduce((acc, curr) => acc + (typeof curr.count === 'number' ? curr.count : 0), 0);
  const totalTechControl = (exploitation.technicalControl || []).reduce((acc, curr) => acc + (typeof curr.count === 'number' ? curr.count : 0), 0);

  if (!data?.exploitation) {
    return (
      <div className="p-12 text-center text-slate-500 bg-white rounded-lg shadow-sm border border-slate-200">
        <Factory className="w-12 h-12 text-slate-300 mx-auto mb-3" />
        <p>Exploitation data is not available.</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      
      {/* --- 1. OPERATING DATA --- */}
      <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
        <div className="mb-8">
            <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                <Factory className="w-5 h-5 text-indigo-600" />
                {t('sec_operating')}
            </h2>
            <div className="overflow-x-auto">
                <table className="w-full text-xs text-left text-slate-600 min-w-250 border-collapse">
                    <thead className="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th className="px-2 py-3 sticky left-0 bg-slate-100 z-10 w-48 border-r border-slate-200 shadow-[1px_0_0_0_rgba(0,0,0,0.05)] border-t border-l">
                                {t('Entity')}
                            </th>
                            <th colSpan={3} className="px-2 py-1 text-center border-l border-r border-t border-slate-300 bg-blue-50 text-blue-800">
                                {t('Volume')}
                            </th>
                            <th colSpan={3} className="px-2 py-1 text-center border-r border-t border-slate-300 bg-green-50 text-green-800">
                                {t('Value')}
                            </th>
                            <th colSpan={3} className="px-2 py-1 text-center border-l border-t border-r bg-purple-50 text-purple-800 font-bold">
                                {t('DPD VERIFICATION')}
                            </th>
                        </tr>
                        <tr className="bg-slate-50 border-b border-slate-200">
                            <th className="sticky left-0 bg-slate-50 z-10 border-r border-l border-slate-200"></th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500 border-l">KGS</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500">mÂ³</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500 border-r">Litre</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500">CIF</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500">FOB</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500 border-r">Merchant</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500 border-l">TARIF OCC</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500">VERIF.</th>
                            <th className="px-1 py-1 text-center text-[10px] text-slate-500 border-r">RESULT</th>
                        </tr>
                    </thead>
                    <tbody>
                        {(exploitation.operatingData || []).map((row) => (
                            <tr key={row.id} className="border-b hover:bg-slate-50">
                                <td className="px-2 py-2 font-medium sticky left-0 bg-white hover:bg-slate-50 z-10 border-r border-l border-slate-200 shadow-[1px_0_0_0_rgba(0,0,0,0.05)]">
                                    {t(row.category)}
                                </td>
                                <td className="p-1 border-l">
                                    <input type="number" className="w-full text-center p-1 border rounded text-xs bg-white text-black focus:ring-2 focus:ring-blue-500 outline-none" value={row.volume?.kgs || 0} onChange={(e) => handleOperatingChange(row.id, 'volume', 'kgs', e.target.value)} />
                                </td>
                                <td className="p-1">
                                    <input type="number" className="w-full text-center p-1 border rounded text-xs bg-white text-black focus:ring-2 focus:ring-blue-500 outline-none" value={row.volume?.m3 || 0} onChange={(e) => handleOperatingChange(row.id, 'volume', 'm3', e.target.value)} />
                                </td>
                                <td className="p-1 border-r">
                                    <input type="number" className="w-full text-center p-1 border rounded text-xs bg-white text-black focus:ring-2 focus:ring-blue-500 outline-none" value={row.volume?.litre || 0} onChange={(e) => handleOperatingChange(row.id, 'volume', 'litre', e.target.value)} />
                                </td>
                                <td className="p-1">
                                    <input type="number" className="w-full text-center p-1 border rounded text-xs bg-white text-black focus:ring-2 focus:ring-green-500 outline-none" value={row.value?.cif || 0} onChange={(e) => handleOperatingChange(row.id, 'value', 'cif', e.target.value)} />
                                </td>
                                <td className="p-1">
                                    <input type="number" className="w-full text-center p-1 border rounded text-xs bg-white text-black focus:ring-2 focus:ring-green-500 outline-none" value={row.value?.fob || 0} onChange={(e) => handleOperatingChange(row.id, 'value', 'fob', e.target.value)} />
                                </td>
                                <td className="p-1 border-r">
                                    <input type="number" className="w-full text-center p-1 border rounded text-xs bg-white text-black focus:ring-2 focus:ring-green-500 outline-none" value={row.value?.marchande || 0} onChange={(e) => handleOperatingChange(row.id, 'value', 'marchande', e.target.value)} />
                                </td>
                                <td className="p-1 border-l">
                                    <input type="number" className="w-full text-center p-1 border rounded text-xs font-semibold bg-white text-black focus:ring-2 focus:ring-purple-500 outline-none" value={row.occFees || 0} onChange={(e) => handleOperatingChange(row.id, 'root', 'occFees', e.target.value)} />
                                </td>
                                <td className="p-1">
                                    <input type="number" className="w-full text-center p-1 border rounded text-xs bg-white text-black focus:ring-2 focus:ring-purple-500 outline-none" value={row.dpdVerification || 0} onChange={(e) => handleOperatingChange(row.id, 'root', 'dpdVerification', e.target.value)} />
                                </td>
                                <td className="p-1 border-r">
                                    <input type="number" className="w-full text-center p-1 border rounded text-xs font-bold bg-white text-black focus:ring-2 focus:ring-purple-500 outline-none" value={row.result || 0} onChange={(e) => handleOperatingChange(row.id, 'root', 'result', e.target.value)} />
                                </td>
                            </tr>
                        ))}
                        <tr className="bg-slate-100 font-bold border-t-2 border-slate-300">
                            <td className="px-2 py-2 text-right sticky left-0 bg-slate-100 z-10 border-r border-l border-slate-300 shadow-[1px_0_0_0_rgba(0,0,0,0.05)] text-slate-700">
                                TOTAL
                            </td>
                            <td className="px-1 py-2 text-center text-xs border-l border-slate-300">{opTotals.kgs.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs">{opTotals.m3.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs border-r border-slate-300">{opTotals.litre.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs">{opTotals.cif.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs">{opTotals.fob.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs border-r border-slate-300">{opTotals.marchande.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs border-l border-slate-300">{opTotals.occFees.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs">{opTotals.dpdVerification.toFixed(2)}</td>
                            <td className="px-1 py-2 text-center text-xs border-r border-slate-300">{opTotals.result.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <hr className="my-8 border-slate-200" />

        {/* --- 2. FAILURES --- */}
        <div className="mb-8">
            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <Activity className="w-5 h-5 text-orange-500" />
                {t('Failures')}
            </h3>
            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left border-collapse border border-slate-200">
                    <thead className="bg-slate-100 text-slate-700">
                        <tr>
                            <th className="p-3 border-b border-r border-slate-200 w-2/3">{t('Benefit')}</th>
                            <th className="p-3 border-b border-slate-200 w-1/3 text-center">{t('Name')}</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                        {(exploitation.failures || []).map(f => (
                            <tr key={f.id} className="hover:bg-slate-50">
                                <td className="p-3 border-r border-slate-200 font-medium text-slate-700">{t(f.name)}</td>
                                <td className="p-2">
                                    <input 
                                        type="text" 
                                        className="w-full text-center p-1 border rounded bg-white text-black outline-none focus:ring-2 focus:ring-orange-400" 
                                        value={f.count} 
                                        onChange={e => handleServiceChange('failures', f.id, e.target.value)} 
                                    />
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>

        <hr className="my-8 border-slate-200" />

        {/* --- 3. LABORATORY ANALYSIS --- */}
        <div className="mb-8">
            <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                <Microscope className="w-5 h-5 text-teal-600" />
                {t('Laboratory Analysis')}
            </h2>
            <div className="overflow-x-auto">
                <table className="w-full text-xs text-left border-collapse border border-slate-200">
                    <thead className="bg-slate-100 text-slate-600">
                        <tr>
                            <th className="p-3 border-b border-r border-slate-200 w-1/3">{t('NATURE SAMPLES')}</th>
                            <th className="p-3 border-b border-r border-slate-200 text-center">{t('RECEIVED')}</th>
                            <th className="p-3 border-b border-r border-slate-200 text-center">{t('ANALYZED')}</th>
                            <th className="p-3 border-b border-r border-slate-200 text-center bg-red-50 text-red-700">{t('NON COMP.')}</th>
                            <th className="p-3 border-b border-slate-200 text-center bg-green-50 text-green-700">{t('CONFORMITY')}</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                        {LAB_SECTIONS.map((section) => {
                            const sectionSubtotal = getSectionSubtotal(section.rows.map(r => r.id));
                            return (
                                <React.Fragment key={section.key}>
                                    <tr className="bg-slate-50 border-b border-slate-200">
                                        <td colSpan={5} className="p-2 font-bold text-slate-800 uppercase tracking-wide">
                                            {t(section.title)}
                                        </td>
                                    </tr>
                                    {section.rows.map((row) => (
                                        <tr key={row.id} className="hover:bg-slate-50">
                                            <td className="p-2 border-r border-slate-200 pl-6">
                                                <div className="text-slate-700">{t(row.label)}</div>
                                            </td>
                                            <td className="p-1 border-r border-slate-200">
                                                <input type="number" min="0" className="w-full p-1 border rounded text-center bg-white text-black outline-none focus:ring-2 focus:ring-teal-500" value={getLabValue(row.id, 'received')} onChange={(e) => handleLabChange(row.id, 'received', e.target.value)} />
                                            </td>
                                            <td className="p-1 border-r border-slate-200">
                                                <input type="number" min="0" className="w-full p-1 border rounded text-center bg-white text-black outline-none focus:ring-2 focus:ring-teal-500" value={getLabValue(row.id, 'analyzed')} onChange={(e) => handleLabChange(row.id, 'analyzed', e.target.value)} />
                                            </td>
                                            <td className="p-1 border-r border-slate-200 bg-red-50/10">
                                                <input type="number" min="0" className="w-full p-1 border border-red-200 rounded text-center bg-white text-black outline-none focus:ring-2 focus:ring-red-400" value={getLabValue(row.id, 'nonCompliant')} onChange={(e) => handleLabChange(row.id, 'nonCompliant', e.target.value)} />
                                            </td>
                                            <td className="p-1 bg-green-50/10">
                                                <input type="number" min="0" className="w-full p-1 border border-green-200 rounded text-center bg-white text-black outline-none focus:ring-2 focus:ring-green-400" value={getLabValue(row.id, 'compliant')} onChange={(e) => handleLabChange(row.id, 'compliant', e.target.value)} />
                                            </td>
                                        </tr>
                                    ))}
                                    <tr className="bg-slate-100 font-semibold border-b border-slate-200 text-slate-700">
                                        <td className="p-2 text-right pr-4 italic text-xs">{t('SOUS TOTAL')}</td>
                                        <td className="p-2 text-center text-xs">{sectionSubtotal.received}</td>
                                        <td className="p-2 text-center text-xs">{sectionSubtotal.analyzed}</td>
                                        <td className="p-2 text-center text-xs">{sectionSubtotal.nonCompliant}</td>
                                        <td className="p-2 text-center text-xs">{sectionSubtotal.compliant}</td>
                                    </tr>
                                </React.Fragment>
                            );
                        })}
                        <tr className="bg-slate-800 text-white font-bold border-t-2 border-slate-900">
                            <td className="p-3 border-r border-slate-700 text-right">{t('TOTAL GLOBAL')}</td>
                            <td className="p-3 border-r border-slate-700 text-center">{labTotals.received}</td>
                            <td className="p-3 border-r border-slate-700 text-center">{labTotals.analyzed}</td>
                            <td className="p-3 border-r border-slate-700 text-center text-red-300">{labTotals.nonCompliant}</td>
                            <td className="p-3 text-center text-green-300">{labTotals.compliant}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <hr className="my-8 border-slate-200" />

        {/* --- 4. METROLOGY --- */}
        <div className="mb-8">
            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <Scale className="w-5 h-5 text-purple-500" />
                {t('Metrology')}
            </h3>
            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left border-collapse border border-slate-200">
                    <thead className="bg-slate-100 text-slate-700">
                        <tr>
                            <th className="p-3 border-b border-r border-slate-200 w-2/3">{t('PRESTATION')}</th>
                            <th className="p-3 border-b border-slate-200 w-1/3 text-center">{t('NUMBER OF DEVICES')}</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                        {(exploitation.metrology || []).map(m => (
                            <tr key={m.id} className="hover:bg-slate-50">
                                <td className="p-3 border-r border-slate-200 font-medium text-slate-700">{t(m.name)}</td>
                                <td className="p-2">
                                    <input 
                                        type="number" 
                                        className="w-full text-center p-1 border rounded bg-white text-black outline-none focus:ring-2 focus:ring-purple-400" 
                                        value={m.count || 0} 
                                        onChange={e => handleServiceChange('metrology', m.id, e.target.value)} 
                                    />
                                </td>
                            </tr>
                        ))}
                        <tr className="bg-slate-100 font-bold border-t border-slate-300">
                            <td className="p-3 border-r border-slate-300 text-right">{t('SUB TOTAL')}</td>
                            <td className="p-3 text-center text-purple-700">{totalMetrology}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <hr className="my-8 border-slate-200" />

        {/* --- 5. TECHNICAL CONTROL --- */}
        <div className="mb-8">
            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <Settings className="w-5 h-5 text-slate-500" />
                {t('TechControl')}
            </h3>
            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left border-collapse border border-slate-200">
                    <thead className="bg-slate-100 text-slate-700">
                        <tr>
                            <th className="p-3 border-b border-r border-slate-200 w-2/3">{t('Designation')}</th>
                            <th className="p-3 border-b border-slate-200 w-1/3 text-center">{t('Count')}</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                        {(exploitation.technicalControl || []).map(tc => (
                            <tr key={tc.id} className="hover:bg-slate-50">
                                <td className="p-3 border-r border-slate-200 font-medium text-slate-700">{t(tc.name)}</td>
                                <td className="p-2">
                                    <input 
                                        type="number" 
                                        className="w-full text-center p-1 border rounded bg-white text-black outline-none focus:ring-2 focus:ring-slate-400" 
                                        value={tc.count || 0} 
                                        onChange={e => handleServiceChange('technicalControl', tc.id, e.target.value)} 
                                    />
                                </td>
                            </tr>
                        ))}
                        <tr className="bg-slate-100 font-bold border-t border-slate-300">
                            <td className="p-3 border-r border-slate-300 text-right">{t('TOTAL')}</td>
                            <td className="p-3 text-center text-slate-700">{totalTechControl}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

      </div>
    </div>
  );
};

export default SectionExploitation;