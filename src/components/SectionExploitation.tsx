import React from 'react';
import { useTranslation } from 'react-i18next';
import type { AppData, ExploitationData } from '../types/budget';
import { Factory, Activity, Scale, Settings } from 'lucide-react';

interface Props {
  data: AppData;
  onChange: (data: AppData) => void;
}

const SectionExploitation: React.FC<Props> = ({ data, onChange }) => {
  const { t } = useTranslation();
  const exploitation = data?.exploitation;

  if (!exploitation) {
    return (
      <div className="p-12 text-center text-slate-500 bg-white rounded-lg shadow-sm border border-slate-200">
        <Factory className="w-12 h-12 text-slate-300 mx-auto mb-3" />
        <p>Exploitation data is not available.</p>
      </div>
    );
  }

  const updateExploitation = (newData: Partial<ExploitationData>) => {
    onChange({
      ...data,
      exploitation: { ...exploitation, ...newData }
    });
  };

  const handleOperatingChange = (id: string, group: 'volume' | 'value' | 'root', field: string, val: string) => {
    const num = parseFloat(val) || 0;
    
    const newOpData = (exploitation.operatingData || []).map(row => {
      if (row.id !== id) return row;
      
      if (group === 'root') {
        return { ...row, [field]: num };
      } else {
        const groupKey = group as 'volume' | 'value';
        const currentGroupData = row[groupKey] || { kgs: 0, m3: 0, litre: 0, cif: 0, fob: 0, marchande: 0 };
        return {
          ...row,
          [groupKey]: { ...currentGroupData, [field]: num }
        };
      }
    });
    updateExploitation({ operatingData: newOpData });
  };

  const handleServiceChange = (
    listName: 'failures' | 'metrology' | 'technicalControl',
    id: string,
    val: string
  ) => {
    let newVal: string | number = val;
    if (listName !== 'failures') {
        newVal = parseFloat(val) || 0;
    }
    
    const list = exploitation[listName] || [];
    const newList = list.map(row => 
      row.id === id ? { ...row, count: newVal } : row
    );
    updateExploitation({ [listName]: newList });
  };

  const opTotals = (exploitation.operatingData || []).reduce((acc, row) => ({
    kgs: acc.kgs + (row.volume?.kgs || 0),
    m3: acc.m3 + (row.volume?.m3 || 0),
    litre: acc.litre + (row.volume?.litre || 0),
    cif: acc.cif + (row.value?.cif || 0),
    fob: acc.fob + (row.value?.fob || 0),
    marchande: acc.marchande + (row.value?.marchande || 0),
    occFees: acc.occFees + (row.occFees || 0),
    dpdVerification: acc.dpdVerification + (row.dpdVerification || 0),
    result: acc.result + (row.result || 0),
  }), { kgs: 0, m3: 0, litre: 0, cif: 0, fob: 0, marchande: 0, occFees: 0, dpdVerification: 0, result: 0 });

  const totalMetrology = (exploitation.metrology || []).reduce((acc, curr) => acc + (typeof curr.count === 'number' ? curr.count : 0), 0);
  const totalTechControl = (exploitation.technicalControl || []).reduce((acc, curr) => acc + (typeof curr.count === 'number' ? curr.count : 0), 0);

  return (
    <div className="space-y-6">
      
      {/* Operating Data Section */}
      <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 overflow-hidden">
        <div className="px-6 py-3 bg-gradient-to-r from-indigo-50 to-slate-50 border-b-2 border-slate-200">
          <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
            <Factory className="w-5 h-5 text-indigo-600" />
            {t('sec_operating')}
          </h2>
        </div>
        
        <div className="overflow-x-auto">
          <table className="w-full text-xs text-left min-w-250 border-collapse">
            <thead className="text-xs text-slate-700 uppercase">
              <tr className="bg-gradient-to-r from-slate-100 to-slate-50 border-b-2 border-slate-300">
                <th className="px-3 py-3 border-r border-slate-200 font-semibold">{t('Product')}</th>
                <th colSpan={3} className="px-2 py-2 text-center border-r border-slate-300 bg-gradient-to-br from-blue-50 to-blue-100 text-blue-800 font-bold">{t('Volume')}</th>
                <th colSpan={3} className="px-2 py-2 text-center border-r border-slate-300 bg-gradient-to-br from-green-50 to-green-100 text-green-800 font-bold">{t('Value')}</th>
                <th colSpan={3} className="px-2 py-2 text-center bg-gradient-to-br from-purple-50 to-purple-100 text-purple-800 font-bold">{t('Fees & Result')}</th>
              </tr>
              <tr className="bg-slate-50 border-b border-slate-200">
                <th className="border-r border-slate-200"></th>
                <th className="px-1 py-2 text-center text-[10px] border-r border-slate-200 font-semibold text-blue-700">KGS</th>
                <th className="px-1 py-2 text-center text-[10px] border-r border-slate-200 font-semibold text-blue-700">M3</th>
                <th className="px-1 py-2 text-center text-[10px] border-r border-slate-300 font-semibold text-blue-700">Litre</th>
                <th className="px-1 py-2 text-center text-[10px] border-r border-slate-200 font-semibold text-green-700">CIF</th>
                <th className="px-1 py-2 text-center text-[10px] border-r border-slate-200 font-semibold text-green-700">FOB</th>
                <th className="px-1 py-2 text-center text-[10px] border-r border-slate-300 font-semibold text-green-700">Marchande</th>
                <th className="px-1 py-2 text-center text-[10px] border-r border-slate-200 font-semibold text-purple-700">OCC Fees</th>
                <th className="px-1 py-2 text-center text-[10px] border-r border-slate-200 font-semibold text-purple-700">DPD</th>
                <th className="px-1 py-2 text-center text-[10px] font-semibold text-purple-700">Result</th>
              </tr>
            </thead>
            <tbody>
              {(exploitation.operatingData || []).map((row) => (
                <tr key={row.id} className="border-b border-slate-200 hover:bg-indigo-50/30 transition-all duration-150">
                  <td className="px-3 py-2 font-semibold border-r border-slate-200 text-slate-800">{t(row.category)}</td>
                  <td className="p-1 border-r border-slate-200 bg-blue-50/20"><input type="number" className="w-full text-center bg-transparent text-black border-2 border-blue-300 rounded-lg p-1 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none transition-all hover:border-blue-400 font-semibold" value={row.volume?.kgs || ''} onChange={(e) => handleOperatingChange(row.id, 'volume', 'kgs', e.target.value)} /></td>
                  <td className="p-1 border-r border-slate-200 bg-blue-50/20"><input type="number" className="w-full text-center bg-transparent text-black border-2 border-blue-300 rounded-lg p-1 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none transition-all hover:border-blue-400 font-semibold" value={row.volume?.m3 || ''} onChange={(e) => handleOperatingChange(row.id, 'volume', 'm3', e.target.value)} /></td>
                  <td className="p-1 border-r border-slate-300 bg-blue-50/20"><input type="number" className="w-full text-center bg-transparent text-black border-2 border-blue-300 rounded-lg p-1 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none transition-all hover:border-blue-400 font-semibold" value={row.volume?.litre || ''} onChange={(e) => handleOperatingChange(row.id, 'volume', 'litre', e.target.value)} /></td>
                  <td className="p-1 border-r border-slate-200 bg-green-50/20"><input type="number" className="w-full text-center bg-transparent text-black border-2 border-green-300 rounded-lg p-1 focus:ring-2 focus:ring-green-400 focus:border-green-400 outline-none transition-all hover:border-green-400 font-semibold" value={row.value?.cif || ''} onChange={(e) => handleOperatingChange(row.id, 'value', 'cif', e.target.value)} /></td>
                  <td className="p-1 border-r border-slate-200 bg-green-50/20"><input type="number" className="w-full text-center bg-transparent text-black border-2 border-green-300 rounded-lg p-1 focus:ring-2 focus:ring-green-400 focus:border-green-400 outline-none transition-all hover:border-green-400 font-semibold" value={row.value?.fob || ''} onChange={(e) => handleOperatingChange(row.id, 'value', 'fob', e.target.value)} /></td>
                  <td className="p-1 border-r border-slate-300 bg-green-50/20"><input type="number" className="w-full text-center bg-transparent text-black border-2 border-green-300 rounded-lg p-1 focus:ring-2 focus:ring-green-400 focus:border-green-400 outline-none transition-all hover:border-green-400 font-semibold" value={row.value?.marchande || ''} onChange={(e) => handleOperatingChange(row.id, 'value', 'marchande', e.target.value)} /></td>
                  <td className="p-1 border-r border-slate-200 bg-purple-50/20"><input type="number" className="w-full text-center bg-transparent text-black border-2 border-purple-300 rounded-lg p-1 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 outline-none transition-all hover:border-purple-400 font-semibold" value={row.occFees || ''} onChange={(e) => handleOperatingChange(row.id, 'root', 'occFees', e.target.value)} /></td>
                  <td className="p-1 border-r border-slate-200 bg-purple-50/20"><input type="number" className="w-full text-center bg-transparent text-black border-2 border-purple-300 rounded-lg p-1 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 outline-none transition-all hover:border-purple-400 font-semibold" value={row.dpdVerification || ''} onChange={(e) => handleOperatingChange(row.id, 'root', 'dpdVerification', e.target.value)} /></td>
                  <td className="p-1 bg-purple-50/20"><input type="number" className="w-full text-center bg-transparent text-black border-2 border-purple-300 rounded-lg p-1 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 outline-none transition-all hover:border-purple-400 font-semibold" value={row.result || ''} onChange={(e) => handleOperatingChange(row.id, 'root', 'result', e.target.value)} /></td>
                </tr>
              ))}
              <tr className="bg-gradient-to-r from-slate-800 to-slate-700 text-white font-bold border-t-2 border-slate-900">
                <td className="px-3 py-2 text-right border-r border-slate-600">TOTAL</td>
                <td className="px-1 py-2 text-center text-xs border-r border-slate-600">{opTotals.kgs.toFixed(2)}</td>
                <td className="px-1 py-2 text-center text-xs border-r border-slate-600">{opTotals.m3.toFixed(2)}</td>
                <td className="px-1 py-2 text-center text-xs border-r border-slate-500">{opTotals.litre.toFixed(2)}</td>
                <td className="px-1 py-2 text-center text-xs border-r border-slate-600">{opTotals.cif.toFixed(2)}</td>
                <td className="px-1 py-2 text-center text-xs border-r border-slate-600">{opTotals.fob.toFixed(2)}</td>
                <td className="px-1 py-2 text-center text-xs border-r border-slate-500">{opTotals.marchande.toFixed(2)}</td>
                <td className="px-1 py-2 text-center text-xs border-r border-slate-600">{opTotals.occFees.toFixed(2)}</td>
                <td className="px-1 py-2 text-center text-xs border-r border-slate-600">{opTotals.dpdVerification.toFixed(2)}</td>
                <td className="px-1 py-2 text-center text-xs">{opTotals.result.toFixed(2)}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      {/* Failures */}
      <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 overflow-hidden">
        <div className="px-6 py-3 bg-gradient-to-r from-orange-50 to-slate-50 border-b-2 border-slate-200">
          <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
              <Activity className="w-5 h-5 text-orange-500" />
              {t('Failures')}
          </h3>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-xs border-collapse">
              <thead className="bg-gradient-to-r from-slate-100 to-slate-50">
                  <tr className="border-b-2 border-slate-300">
                      <th className="px-3 py-2 text-left font-semibold text-slate-700 border-r border-slate-200">{t('Type')}</th>
                      <th className="px-3 py-2 text-center font-semibold text-slate-700">{t('Description')}</th>
                  </tr>
              </thead>
              <tbody>
                  {(exploitation.failures || []).map(f => (
                      <tr key={f.id} className="border-b border-slate-200 hover:bg-orange-50/30 transition-all duration-150">
                          <td className="px-3 py-2 font-semibold text-slate-800 border-r border-slate-200">{t(f.name)}</td>
                          <td className="p-1"><input className="w-full p-2 bg-white text-black border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-orange-400 outline-none transition-all hover:border-orange-400 text-xs" value={f.count} onChange={e => handleServiceChange('failures', f.id, e.target.value)} /></td>
                      </tr>
                  ))}
              </tbody>
          </table>
        </div>
      </div>

      {/* Metrology */}
      <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 overflow-hidden">
        <div className="px-6 py-3 bg-gradient-to-r from-purple-50 to-slate-50 border-b-2 border-slate-200">
          <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
              <Scale className="w-5 h-5 text-purple-500" />
              {t('Metrology')}
          </h3>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-xs border-collapse">
              <thead className="bg-gradient-to-r from-slate-100 to-slate-50">
                  <tr className="border-b-2 border-slate-300">
                      <th className="px-3 py-2 text-left font-semibold text-slate-700 border-r border-slate-200">{t('Type')}</th>
                      <th className="px-3 py-2 text-center font-semibold text-slate-700">{t('Count')}</th>
                  </tr>
              </thead>
              <tbody>
                  {(exploitation.metrology || []).map(m => (
                      <tr key={m.id} className="border-b border-slate-200 hover:bg-purple-50/30 transition-all duration-150">
                          <td className="px-3 py-2 font-semibold text-slate-800 border-r border-slate-200">{t(m.name)}</td>
                          <td className="p-1"><input type="number" className="w-full p-2 text-center bg-white text-black border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-purple-400 outline-none transition-all hover:border-purple-400 text-xs font-semibold" value={m.count || ''} onChange={e => handleServiceChange('metrology', m.id, e.target.value)} /></td>
                      </tr>
                  ))}
                  <tr className="bg-gradient-to-r from-slate-800 to-slate-700 text-white font-bold border-t-2 border-slate-900">
                      <td className="px-3 py-2 text-right border-r border-slate-600">TOTAL</td>
                      <td className="px-3 py-2 text-center">{totalMetrology}</td>
                  </tr>
              </tbody>
          </table>
        </div>
      </div>

      {/* Technical Control */}
      <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 overflow-hidden">
        <div className="px-6 py-3 bg-gradient-to-r from-slate-50 to-slate-100 border-b-2 border-slate-200">
          <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
              <Settings className="w-5 h-5 text-slate-600" />
              {t('TechControl')}
          </h3>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-xs border-collapse">
              <thead className="bg-gradient-to-r from-slate-100 to-slate-50">
                  <tr className="border-b-2 border-slate-300">
                      <th className="px-3 py-2 text-left font-semibold text-slate-700 border-r border-slate-200">{t('Type')}</th>
                      <th className="px-3 py-2 text-center font-semibold text-slate-700">{t('Count')}</th>
                  </tr>
              </thead>
              <tbody>
                  {(exploitation.technicalControl || []).map(tc => (
                      <tr key={tc.id} className="border-b border-slate-200 hover:bg-slate-100/50 transition-all duration-150">
                          <td className="px-3 py-2 font-semibold text-slate-800 border-r border-slate-200">{t(tc.name)}</td>
                          <td className="p-1"><input type="number" className="w-full p-2 text-center bg-white text-black border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-400 focus:border-slate-400 outline-none transition-all hover:border-slate-400 text-xs font-semibold" value={tc.count || ''} onChange={e => handleServiceChange('technicalControl', tc.id, e.target.value)} /></td>
                      </tr>
                  ))}
                  <tr className="bg-gradient-to-r from-slate-800 to-slate-700 text-white font-bold border-t-2 border-slate-900">
                      <td className="px-3 py-2 text-right border-r border-slate-600">TOTAL</td>
                      <td className="px-3 py-2 text-center">{totalTechControl}</td>
                  </tr>
              </tbody>
          </table>
        </div>
      </div>

    </div>
  );
};

export default SectionExploitation;
